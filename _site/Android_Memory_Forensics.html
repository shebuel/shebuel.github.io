<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
        <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Android Memory Forensics | Shebuel Asher Paul</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Android Memory Forensics" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Disclaimer: This post is either a very good or a horrible representation of my writing skills depending on how much you like it" />
<meta property="og:description" content="Disclaimer: This post is either a very good or a horrible representation of my writing skills depending on how much you like it" />
<link rel="canonical" href="http://localhost:4000/Android_Memory_Forensics" />
<meta property="og:url" content="http://localhost:4000/Android_Memory_Forensics" />
<meta property="og:site_name" content="Shebuel Asher Paul" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-04-21T00:00:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Android Memory Forensics" />
<meta name="twitter:site" content="@" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Android_Memory_Forensics"},"@type":"BlogPosting","url":"http://localhost:4000/Android_Memory_Forensics","headline":"Android Memory Forensics","dateModified":"2020-04-21T00:00:00-07:00","datePublished":"2020-04-21T00:00:00-07:00","description":"Disclaimer: This post is either a very good or a horrible representation of my writing skills depending on how much you like it","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    

    <!-- Site Favicon -->
    <link rel="shortcut icon" href="http://localhost:4000/assets/images/favicon1.ico" type="image/png" />

    <!-- Font Embed Code -->
	<link href="https://fonts.googleapis.com/css?family=Crimson+Text:400,400i,600,600i|Karla:400,400i,700,700i" rel="stylesheet">

    <!-- CSS Styles -->
    <link href="/assets/css/style.css" rel="stylesheet">
</head>



<body class="layout-post">
    <div id="page" class="site">
        <header id="masthead" class="site-header">
    <div class="site-header-wrap">
        <div class="site-header-inside">

            <div class="site-branding">
                
                <p class="profile">
                    <a href="/">
                        <img src="/assets/images/websiteImageDP.jpg" alt="'s Picture"
                            class="avatar" />
                    </a>
                </p>
                <div class="site-identity">
                    
                    <h1 class="site-title">
                        <a href="/">Shebuel Asher Paul</a>
                    </h1>
                    
                    
                    <p class="site-description">Security Analyst</p>
                    
                </div><!-- .site-identity -->
                
                <button id="menu-toggle" class="menu-toggle"><span class="screen-reader-text">Main Menu</span><span
                        class="icon-menu" aria-hidden="true"></span></button>
            </div><!-- .site-branding -->

            <nav id="main-navigation" class="site-navigation" aria-label="Main Navigation">
                <div class="site-nav-wrap">
                    <div class="site-nav-inside">
                    <ul class="menu">
                        
                        
                        
                        <li class="menu-item "><a href="/">Home</a></li>
                        
                        
                        
                        <li class="menu-item "><a href="/about">About</a></li>
                        
                        
                        
                        <li class="menu-item "><a href="/contact">Contact Me</a></li>
                        
                        
                        
                        <li class="menu-item "><a href="/search">Search</a></li>
                        
                    </ul>
                    <p class="social-links">
    
    <a href="https://twitter.com/jshebuel" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
    <a href="https://github.com/shebuel" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
    
    
    <a href="https://www.instagram.com/shebuel_ash3r" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
    <a href="https://www.linkedin.com/in/shebuel" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
</p>
                    </div><!-- .site-nav-inside -->
                </div><!-- .site-nav-wrap -->
            </nav><!-- .site-navigation -->

        </div><!-- .site-header-inside -->
    </div><!-- .site-header-wrap -->
</header><!-- .site-header -->
        <div id="content" class="site-content fadeInDown delay_075s">
            <div class="inner-wide">
                    <main id="main" class="site-main">
    
        <article class="post-full inner">

            <header class="post-header">
                <div class="post-meta">
                    <time class="post-date" datetime="2020-04-21">April 21,
                        2020</time>
                </div><!-- .post-meta -->
                <h1 class="post-title">Android Memory Forensics</h1>
                
                <div class="post-tags">
                     
                    <a href='tag/android/'>Android</a>
                    
                     
                    <a href='tag/memory- forensics/'>Memory Forensics</a>
                    
                    
                </div>
                
            </header><!-- .post-header -->

            
            <div class="post-thumbnail">
                <img src="assets/images/posts/2020/android.jpg" alt="Android Memory Forensics">
            </div>
            
            <div class="post-content">
                <p><em><strong>Disclaimer</strong>:
This post is either a very good or a horrible representation of my writing skills depending on how much you like it</em></p>

<h2 id="memory-forensics">Memory Forensics:</h2>

<p>Memory forensics is essentially just a subset in the computer forensic field where the goal is to focus on the contents of snapshot of memory (RAM) rather than the contents of the hard disk. Memory forensics has its own set of difficulties the worst of which is that the content in memory is volatile meaning once the machine loses power all the contents of memory are pretty much gone for good (Unless you manage to instantly freeze but I am not sure about the science behind that). Memory forensics has been gaining a lot of traction recently mostly due to the fact that there are a lot more memory resident malware and memory resided data often provide a fresh real-time perspective to an investigation case.</p>

<h2 id="memory-forensics-in-android-devices">Memory forensics in android devices:</h2>

<p>Android which is currently the most popular mobile OS is a framework which runs on top of the Linux kernel. So many things that apply to UNIX systems also apply to Android except the way that applications are run (used to be Dalvik VMs, now Android Run Time (ART) environment). The important thing in regards to this project is that Android similar to Linux allows for loadable kernel modules (LKMs). (<em>My future self: “Oh my sweet summer child”</em>)</p>

<p>Ways to extract memory</p>
<ul>
  <li>/dev/(k)mem</li>
  <li>Fmem</li>
  <li>Crash</li>
  <li>Wont get into the hardware ways (Jtag maybe be a possible way but hard to get to w/o removing the battery)</li>
</ul>

<p>There is a very good presentation from the creators of the tool that I am about to use which you can find <a href="https://www.youtube.com/watch?v=oWkOyphlmM8">here</a></p>

<h2 id="my-test-environment">My test environment</h2>

<ul>
  <li>Nexus 5
    <ul>
      <li>Android 6.0.1 (Latest update, EOL)</li>
      <li>kernel version is 3.4.0-gcf10b7e</li>
      <li>Rooted</li>
    </ul>
  </li>
  <li>SIFT Workstation
    <ul>
      <li>Volatility</li>
      <li>Ubuntu 14.04</li>
      <li>Kernel 4.4.0-177-generic</li>
    </ul>
  </li>
  <li>USB to Micro USB cable</li>
</ul>

<p>Okay. I know what you are thinking. Hey Sheb, that’s kind of convenient that the phone that you are trying to analyze is just randomly rooted and I agree. What are the odds right. I guess I am just that lucky. *wink* *wink*</p>

<p>The reason I chose the SIFT workstation is only because it had Volatility pre-installed and I wouldn’t need to setup anything. That being said the steps should be similar in any other Linux machine I think.</p>

<h2 id="lime">LiME</h2>

<p>LiME extractor is what I am going to be using for extracting the memory for analysis.</p>

<p>Just from reading the documentation and having a quick look at the video this is what I learned…</p>

<ul>
  <li>LiME uses loadable kernel modules to load a kernel module directly into a running system (Duh!)</li>
  <li>Once the kernel is loaded the kernel checks the /proc/iomem to figure out the location of the “System RAM” and then uses that physical memory address to carve it out.</li>
  <li>It then sends the data back to the TCP port that was setup when making the kernel module or stores it in the certain location in the SD card.</li>
</ul>

<p>I think one of the best things I learned in life is from <a href="https://ippsec.rocks/#">Ippsec</a>. It is to have a good understanding of the tools that you use so that If you are in a pinch and do not have access to the tools you can create a rudimentary version yourself.
So all thats left to do is look at the source code for the lime extractor and see if I have guessed everything right… This should be fun ( I meant that in the most sarcastic way possible… End my life already)</p>

<p>The following code found in main.c of the lime iterated through all the entries in /proc/iomem and if the name is “System RAM” then see whether the user selected Lime format or the padded format and creates the respective header and then copies the pages represented by that memory range using the <code class="highlighter-rouge">write_range()</code> function.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">iomem_resource</span><span class="p">.</span><span class="n">child</span><span class="p">;</span> <span class="n">p</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">LIME_RAMSTR</span><span class="p">))</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LIME_MODE_LIME</span> <span class="o">&amp;&amp;</span> <span class="n">write_lime_header</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG</span><span class="p">(</span><span class="s">"Error writing header 0x%lx - 0x%lx"</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LIME_MODE_PADDED</span> <span class="o">&amp;&amp;</span> <span class="n">write_padding</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">p_last</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DBG</span><span class="p">(</span><span class="s">"Error writing padding 0x%lx - 0x%lx"</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">p_last</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">write_range</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</code></pre></div></div>

<p>The structure for <code class="highlighter-rouge">iomem_resource</code> can be found in resource.h</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">resource</span> <span class="n">iomem_resource</span> <span class="o">=</span> <span class="p">{</span>
   <span class="mi">36</span>     <span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">"PCI mem"</span><span class="p">,</span>
   <span class="mi">37</span>     <span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
   <span class="mi">38</span>     <span class="p">.</span><span class="n">end</span>    <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
   <span class="mi">39</span>     <span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
   <span class="mi">40</span> <span class="p">};</span>
</code></pre></div></div>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">resource</span> <span class="p">{</span>
        <span class="n">resource_size_t</span> <span class="n">start</span><span class="p">;</span>
        <span class="n">resource_size_t</span> <span class="n">end</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="n">sibling</span><span class="p">,</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
    <span class="p">};</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">write_range()</code> function gets a resource structure and checks if the page is the same as the page size or it needs to be padded. It then calls the <code class="highlighter-rouge">write_vaddr()</code> function which in turn calls the <code class="highlighter-rouge">write_vaddr_tcp()</code> or the <code class="highlighter-rouge">write_vaddr_disk()</code> function based on how the memory is to be stored.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span> <span class="p">(</span><span class="n">no_overlap</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">copy_page</span><span class="p">(</span><span class="n">vpage</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">write_vaddr</span><span class="p">(</span><span class="n">vpage</span><span class="p">,</span> <span class="n">is</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">write_vaddr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">is</span><span class="p">);</span>
            <span class="p">}</span>

</code></pre></div></div>
<p>^ Code from <code class="highlighter-rouge">write_range()</code> function</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Run deflate() on input until output buffer is not full. */</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">try_write</span><span class="p">(</span><span class="n">deflate_page_buf</span><span class="p">,</span> <span class="n">deflate</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">is</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
</code></pre></div></div>
<p>^ Code from <code class="highlighter-rouge">write_vaddr()</code> function</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">ret</span> <span class="o">=</span> <span class="n">RETRY_IF_INTERRUPTED</span><span class="p">(</span>
        <span class="p">(</span><span class="n">method</span> <span class="o">==</span> <span class="n">LIME_METHOD_TCP</span><span class="p">)</span> <span class="o">?</span> <span class="n">write_vaddr_tcp</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">is</span><span class="p">)</span> <span class="o">:</span> <span class="n">write_vaddr_disk</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">is</span><span class="p">)</span>
    <span class="p">);</span>
</code></pre></div></div>
<p>^ Code from <code class="highlighter-rouge">try_write()</code></p>

<p>I spent like 5 hours analyzing all the code ( I have never made a Kernel module before) and then realized that “The Art of Memory Forensics” has already explained the code in its notes section. Currently reconsidering life decisions. Send help!</p>

<h2 id="memory-extraction">Memory Extraction:</h2>

<h3 id="obtaining-the-kernel-config">Obtaining the kernel config:</h3>

<p>So getting the kernel config sounded super easy when looking at the lime documentation but it actually turned out much harder than I expected.</p>

<p>So this is what the lime documentation has to say about obtaining the kernel config</p>

<p>Installed the prerequisites, downloaded the NDK from <a href="https://github.com/android/ndk/wiki/Unsupported-Download">here</a> and downloaded the SDK and kernel from official android source. I just created a file with all of the paths just so the I can source it from there every time. My source file looked something like this…</p>

<p><img src="/assets/images/posts/2020/exports.png" alt="exports" /></p>

<p>We must then retrieve and copy the kernel config from our device. As per the LiME docs,</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> <span class="nv">$SDK_PATH</span>/platform-tools
./adb pull /proc/config.gz
<span class="nb">gunzip</span> ./config.gz
<span class="nb">cp </span>config <span class="nv">$KSRC_PATH</span>/.config
</code></pre></div></div>
<p>Simple enough… So lets try that..</p>

<p>Hmm… Thats strange… That file does not exist… *<em>Spends 30 mins spell checking and finds nothing</em>*</p>

<p>So time to Google…</p>

<p>I found out that only kernels that are configured with the <code class="highlighter-rouge">CONFIG_IKCONFIG</code> or the <code class="highlighter-rouge">CONFIG_IKCONFIG_PROC</code> ( Which are usually not enabled by default ) are enabled will have the the config available in /proc/config.gz.</p>

<p>Some phones also have the config.gz stored in /vendor/kernel so be sure to check that out too.</p>

<p>I also find that devices which have CWM (clockworkmod) have that configuration enabled by default. It’s kind of hard to assume that the suspect who I want to analyze is the same amount of a nerd I am and has modded his phone. Apparently some Xperia phones and a lot of Huawei phones also have it enabled by default. So if that’s what you have to analyze you are in luck. Must. Be. Nice.</p>

<p>Okay, this is going to be a little more complicated than I initially thought it would be…</p>

<p>At this point I should have just built the config file myself from the kernel source but I wanted to take the easy way out and just find a way to get it from the device. My argument was that “Hey, that will be the most accurate config file”. The problem with that argument was that I am using a Nexus device and that is almost always going to be built on the default config.</p>

<p>So I tried using the method that is mentioned in <a href="https://jiafei427.wordpress.com/2016/11/01/how-to-extract-kernel-configuration-from-android-kernel-or-boot-img-and-build-related-kernel-for-the-device/">this article</a> to extract the kernel image from the device and then use the extract-ikconfig.sh found in scripts/ folder.</p>

<p>// Fun fact… U can just get the zImage of the kernel directly from android source.</p>

<p>After years of struggling I managed to obtain the boot.img file and extract the kernel image from that. Its finally time to use the script and get the kernel config.</p>

<p><img src="/assets/images/posts/2020/extract_ikconfig.png" alt="extract-ikconfig terminal" /></p>

<p>Well that did not go as expected… <em>Spends some more years making sure that he did everything right</em></p>

<p>Well there is no way there is another config setting for this right? RIGHT?</p>

<p><img src="/assets/images/posts/2020/extract_ikconf.png" alt="Extract IKconf" /></p>

<p><img src="https://media.giphy.com/media/5saWnCIJL7nmU/source.gif" alt="gif" /></p>

<p><em>Finally accepts his fate and compiles the config from the source code.</em></p>

<p>These are the commands I used from the source directory:</p>

<pre><code class="language-shell">
export ARCH=arm
export SUBARCH=armexport
CROSS_COMPILE=$CC_PATH/arm-linux-androideabi-

make hammerhead_defconfig
</code></pre>

<p>Now that I finally have the .config file I can follow the LiME docs again to finish my work.</p>

<p>Okay, I just have to make changed to the Makefile(as per the LiME docs) and run make. Seems simple enough.</p>

<p>I did not take a screen shot of the error but this is the error message I got:</p>

<p>“The present kernel configuration has modules disabled.Type ‘make config’ and enable loadable module support.Then build a kernel with module support enabled
make:  [modules] Error 1”</p>

<p>I found the solution from a similar blog post to the one I am making. Wait someone already did all this work??? AHHHHHHH.</p>

<p>You can find the post <a href="https://sgros-students.blogspot.com/2014/04/lime.html">here</a></p>

<p>I just had make changes to the config file and add the following lines.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CONFIG_MODULES=y
CONFIG_MODULE_UNLOAD=y
</code></pre></div></div>

<p>*<em>At this point I was honestly just happy to find a solution and didnt really think about what the solution did but I later realized a very big problem that I had</em>*</p>

<p>Well that worked and I obtained a lime.ko file.</p>

<p>Again following the LiME docs I did the following commands to push my .ko file to the device and the load the kernel module.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb push lime.ko /sdcard/lime.ko
adb forward tcp:4444 tcp:4444
adb shell
su
<span class="c"># insmod /sdcard/lime.ko “path=tcp:4444 format=lime”</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/2020/insmod.png" alt="insmod terminal image here" /></p>

<p>Wait that’s not right… There is no way it’s a config problem again right? RIGHT?</p>

<p><img src="/assets/images/posts/2020/kernel_config.png" alt="Android kernel config page" /></p>

<p>Obviously if I had noticed what changes I am adding to the config file when making lime.ko I would have realized that for android to accept LKM it has to have those config options enabled which wasnt in the default config and obviously wouldn’t in the actual device.</p>

<p>The only method I can see working now is to flash a custom kernel with those configs enabled but that would require a reboot which kind of makes a large part of why I am doing this go down the drain.</p>

<p>So I shall end this post here. I may make another blog on playing around with volatility with an android memory capture just to see all the information that I could gain.</p>


            </div>
            <footer class="post-footer">
                <div class="post-share">
                    <span class="post-share-title">Share:</span>
                    <a target="_blank" href="https://twitter.com/share?text=Android+Memory+Forensics&amp;url=https://royce.netlify.com/Android_Memory_Forensics">Twitter</a>
                    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://royce.netlify.com/Android_Memory_Forensics">Facebook</a>
                </div><!-- .share-post -->
            </footer>
            
<section id="comments-area" class="comments-area">
    <h2 class="comments-title">Comments</h2>
    <div class="comments-inside">
        <div id="disqus_thread"></div>
    </div><!-- .comments-inside -->
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section><!-- .comments-area -->
<script type="text/javascript">
    var disqus_shortname = '';
    var disqus_developer = 0;
    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</section>

        </article>
        
        <section class="read-next inner">
            <h2 class="read-next-title">Read Next</h2>
            
            <article class="post">
                <header class="post-header">
                    <div class="post-meta">
                        <time class="published" datetime="March 16, 2020">March 16, 2020</time>
                    </div>
                    <h3 class="post-title"><a href="/Deception_in_Cybersecurity">Deception in Cybersecurity</a></h3>
                    <p class="post-tags">
                        
                        
                        
                        <a href='/tag/cybersecurity/'>Cybersecurity</a>
                        
                        
                        
                        <a href='/tag/deception/'>Deception</a>
                        
                        
                        
                        <a href='/tag/defense/'>Defense</a>
                        
                        
                        
                    </p>
                </header>
            </article>
            
            
        </section><!-- .read-next -->

        <!-- Create a sorted array of tags -->
         
        <section class="tagcloud inner">
            <h2 class="tagcloud-title">Tags</h2>
            <div class="tag-links">
                
                <a href='https://royce.netlify.com/tag/aws/'>AWS</a>
                
                <a href='https://royce.netlify.com/tag/android/'>Android</a>
                
                <a href='https://royce.netlify.com/tag/ctf/'>CTF</a>
                
                <a href='https://royce.netlify.com/tag/cloudsec/'>CloudSec</a>
                
                <a href='https://royce.netlify.com/tag/cybersecurity/'>Cybersecurity</a>
                
                <a href='https://royce.netlify.com/tag/deception/'>Deception</a>
                
                <a href='https://royce.netlify.com/tag/defense/'>Defense</a>
                
                <a href='https://royce.netlify.com/tag/docs/'>Docs</a>
                
                <a href='https://royce.netlify.com/tag/memory- forensics/'>Memory Forensics</a>
                
                <a href='https://royce.netlify.com/tag/reverese- engineering/'>Reverese Engineering</a>
                
                <a href='https://royce.netlify.com/tag/vulnerability/'>Vulnerability</a>
                
                <a href='https://royce.netlify.com/tag/writeups/'>Writeups</a>
                
            </div><!-- .tag-links -->
        </section><!-- .tagcloud -->

    </main><!-- .site-main -->

                

                
                <footer id="colophon" class="site-footer">
    <p class="site-info inner">
        <a href="#">Shebuel Asher Paul</a> &copy; 2020. Royce theme by
        <a target="_blank" href="https://justgoodthemes.com/">JustGoodThemes</a>.
        <br />
        Powered by <a target="_blank" href="https://jekyllrb.com/">Jekyll</a>.
    </p>
    <a id="back-to-top" class="back-to-top" href="#page">
        <span class="icon-arrow-up" aria-hidden="true"></span>
        <span class="screen-reader-text">Back to top</span>
    </a>
</footer><!-- .site-footer -->
            </div><!-- .inner-wide -->
        </div><!-- .site-content -->
    </div><!-- .site -->

    
    <!-- Javascript Assets -->
    <script src="/assets/js/jquery-3.3.1.min.js"></script>
    <script src="/assets/js/plugins.js"></script>
    <script src="/assets/js/custom.js"></script>

</body>

</html>